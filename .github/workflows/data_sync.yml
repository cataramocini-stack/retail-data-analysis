name: Market Volatility Analysis Pipeline

on:
  schedule:
    # FrequÃªncia mÃ¡xima permitida (cada 5 minutos)
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: ğŸš€ Ciclo de Captura de Alta FrequÃªncia
        env:
          INGESTION_ENDPOINT_PRIMARY: ${{ secrets.INGESTION_ENDPOINT_PRIMARY }}
          AFFILIATION_DATA_METRIC: ${{ secrets.AFFILIATION_DATA_METRIC }}
        run: |
          # Rodada 1: Executa imediatamente
          echo "Iniciando Rodada 1..."
          python market_regressor_engine.py
          
          # Pausa de 100 segundos para dar tempo de novas ofertas aparecerem
          echo "Aguardando 100 segundos para rotaÃ§Ã£o de cache..."
          sleep 100
          
          # Rodada 2: Executa novamente no mesmo container
          echo "Iniciando Rodada 2..."
          python market_regressor_engine.py

      - name: ğŸ”„ Sincronizar Banco de Dados
        if: always()
        run: |
          git config user.name "Market Regressor Bot"
          git config user.email "bot@market-regressor.local"
          git add processed_metadata.db
          # SÃ³ faz o push se houver novos itens processados no banco de dados 
          git diff --cached --quiet || (git commit -m "sync: update metadata store" && git push)
