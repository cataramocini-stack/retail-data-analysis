name: Market Volatility Analysis Pipeline

on:
  schedule:
    # Roda a cada 5 minutos, mas deslocado para o minuto 3
    # Ex: 10:03, 10:08, 10:13... evitando conflito com Steam (00) e Twitch (05)
    - cron: "3-59/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          pip install --upgrade pip
          pip install "setuptools<70.0.0"
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: ğŸš€ Ciclo de Captura de Alta FrequÃªncia
        env:
          INGESTION_ENDPOINT_PRIMARY: ${{ secrets.INGESTION_ENDPOINT_PRIMARY }}
          AFFILIATION_DATA_METRIC: ${{ secrets.AFFILIATION_DATA_METRIC }}
        run: |
          # Rodada 1
          python market_regressor_engine.py
          
          # Pausa estratÃ©gica para pegar a prÃ³xima oferta
          sleep 100
          
          # Rodada 2
          python market_regressor_engine.py

      - name: ğŸ”„ Sincronizar Banco de Dados
        if: always()
        run: |
          git config user.name "Market Regressor Bot"
          git config user.email "bot@market-regressor.local"
          git add processed_metadata.db
          git diff --cached --quiet || (git commit -m "sync: update metadata store" && git push)
